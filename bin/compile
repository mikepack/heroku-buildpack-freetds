#!/usr/bin/env ruby

# sync output
$stdout.sync = true

BUILD_DIR = ARGV[0]
CACHE_DIR = ARGV[1]
ARCHIVE_NAME = "freetds-patched"
INSTALL_DIR = "#{BUILD_DIR}/vendor/freetds"

puts "-----> FreeTDS building in #{BUILD_DIR}"
puts `mkdir -p #{INSTALL_DIR}`

puts "-----> Fetching & Extracting FreeTDS"
puts `curl ftp://ftp.freetds.org/pub/freetds/stable/#{ARCHIVE_NAME}.tar.gz -o - | tar -xz -C #{INSTALL_DIR} -f -`

TARGET_DIR = `ls #{INSTALL_DIR} | grep 'freetds-[0-9]\.'`.chomp
puts "installing #{TARGET_DIR}"

puts "-----> Configuring FreeTDS"
puts `cd #{INSTALL_DIR}/#{TARGET_DIR} && ./configure --prefix=#{INSTALL_DIR} --with-libiconv-prefix=DIR --with-openssl=DIR --with-tdsver=7.3`

puts "-----> Building FreeTDS"
puts `cd #{INSTALL_DIR}/#{TARGET_DIR} && make`

puts "-----> Installing FreeTDS into #{INSTALL_DIR}"
puts `cd #{INSTALL_DIR}/#{TARGET_DIR} && make install`

# puts "-----> Copying FreeTDS into /app/vendor/freetds"
# puts `cp -r #{BUILD_DIR}/vendor/freetds /app/vendor/freetds`

# puts "-----> Writing FreeTDS configuration for subsequent buildpack"

# File.open("export", "a") do |file|
#   file.write("export FREETDS_DIR=/app/vendor/freetds")
# end
